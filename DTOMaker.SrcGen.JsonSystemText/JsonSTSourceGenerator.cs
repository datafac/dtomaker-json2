using DTOMaker.SrcGen.Core;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Text;

namespace DTOMaker.SrcGen.JsonSystemText
{

    [Generator]
    public sealed class JsonSTSourceGenerator : SourceGeneratorBase
    {
        protected override void OnBeginInitialize(IncrementalGeneratorInitializationContext context)
        {
        }
        protected override void OnEndInitialize(IncrementalGeneratorInitializationContext context, IncrementalValuesProvider<OutputEntity> entities)
        {
            // generate entities
            context.RegisterSourceOutput(entities, (spc, ent) =>
            {
                var sb = new StringBuilder();
                sb.AppendLine("// <auto-generated/>");
                sb.AppendLine($"// FullName : {ent.Intf.FullName}");
                sb.AppendLine($"// Namespace: {ent.Intf.Space}");
                sb.AppendLine($"// IntfName : {ent.Intf.Name}");
                sb.AppendLine($"// Id       : {ent.EntityId}");
                sb.AppendLine($"// Height   : {ent.ClassHeight}");
                sb.AppendLine($"// Members  : {ent.Members.Count}");
                foreach (var member in ent.Members)
                {
                    sb.AppendLine($"//       {member.Sequence,3}: {member.Name} ({member.MemberType}{(member.IsNullable ? "?" : "")})");
                }
                sb.AppendLine($"// Base     : {ent.BaseEntity?.Intf.FullName ?? "(null)"}");
                sb.AppendLine($"// Derived  : {ent.DerivedEntities.Count}");
                foreach (var derived in ent.DerivedEntities)
                {
                    sb.AppendLine($"//          - {derived.Intf.FullName}");
                }
                string implName = ent.Intf.Name.Substring(1);
                string hintName = $"{ent.Intf.Space}.JsonSystemText.{implName}.g.cs";
                spc.AddSource(hintName, SourceText.From(sb.ToString(), Encoding.UTF8));
            });
        }
    }
}
